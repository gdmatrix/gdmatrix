<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:gdm="http://gdmatrix.org/faces"
                xmlns:pe="http://primefaces.org/ui/extensions"
                xmlns:sf="http://faces.santfeliu.org">

  <f:loadBundle basename="org.santfeliu.web.obj.resources.ObjectBundle"
                var="objectBundle" />
  <h:outputStylesheet library="css" name="assistant.css" />

  <div class="flex flex-column h-full">
    <div id="assistant_toolbar" 
         class="p-2 pl-3 pr-3 flex flex-grow-0 align-items-center border-none border-solid border-bottom-1"
         style="border-color:var(--surface-border)">
      <div class="flex-grow-0 text-left align-items-center" style="color:var(--text-color)">
        <strong>#{assistantBean.assistant.name}</strong>
      </div>
      <div class="buttons flex flex-grow-1 justify-content-end gap-2">
        <p:commandButton value="Setup"
                         action="#{assistantBean.setView('assistant')}"
                         icon="pi pi-cog"
                         process="@form:cnt" update="@form:cnt" />
      </div>
    </div>
    
    <div id="assistant_body" class="p-3 flex-grow-1 overflow-auto flex flex-column"
         style="color:var(--text-color)">  

      <p:messages showSummary="true" styleClass="messages"
                  showIcon="true" closable="true" forIgnores="growl">
        <p:autoUpdate />
      </p:messages>    
      
      <div class="flex-grow-0 flex-shrink-0 ui-fluid formgrid grid">
        <div class="field col-12 overflow-hidden">
          <div class="ui-inputgroup">
            <p:outputLabel value="Thread" for="thread_selector" styleClass="ui-inputgroup-addon w-8rem"/>
            <p:selectOneMenu value="#{assistantBean.threadId}" 
                             styleClass="overflow-x-hidden"
                             id="thread_selector" autoWidth="false">
              <f:selectItems value="#{assistantBean.threadSelectItems}" />
              <p:ajax event="valueChange" listener="#{assistantBean.onThreadChange}"
                      process="@this" update="@form:cnt:message_list" 
                      oncomplete="scrollMessages()" />
            </p:selectOneMenu>
            <p:commandButton value="#{objectBundle.create}"
                             action="#{assistantBean.createThread}"
                             icon="pi pi-plus-circle"
                             styleClass="mini white-space-nowrap"
                             process="@form:cnt" update="@form:cnt" />
            <p:commandButton value="#{objectBundle.delete}"
                             action="#{assistantBean.deleteThread}"
                             icon="pi pi-trash"
                             styleClass="mini white-space-nowrap"
                             process="@form:cnt" update="@form:cnt" />
          </div>
        </div>
      </div>

      <h:panelGroup id="message_list" layout="block"
                    styleClass="flex-grow-1 flex-shrink-1 overflow-auto message_list">
        <ul class="list-none pl-0">
          <ui:repeat value="#{assistantBean.messageList.data}" var="message">
            <li>
              <div class="flex m-2 mb-4">
                <div class="flex-grow-0">
                  <div class="avatar #{message.role == 'user' ? 'user' : 'assistant'}">
                    <span />
                  </div>
                </div>
                <div class="flex-grow-1 flex flex-column ml-2">
                  <div>
                    <b>#{message.role == 'user' ? 'Tu' : 'Assistent'}</b>                  
                  </div>
                  <div>
                    #{message.content.get(0).text.value}
                  </div>
                </div>
              </div>
            </li>
          </ui:repeat>
    
          <h:panelGroup rendered="#{assistantBean.isProcessing()}">
            <li>
              <div class="stage ml-5">
                <div class="dot-typing" />
              </div>
             </li>
          </h:panelGroup>          
        </ul>
      </h:panelGroup>
             
      <div class="flex-grow-0 flex-shrink-0 flex pt-3">
        <p:inputTextarea id="question" value="#{assistantBean.text}"
                         styleClass="w-full" rows="3" placeholder="Your question..." />
        <p:commandButton action="#{assistantBean.createMessage()}"
                         process="@form:cnt" update="@form:cnt"
                         oncomplete="scrollMessages();assist()"
                         icon="pi pi-arrow-up" styleClass="ui-button-outlined ml-2" />
      </div>      
      
    </div>
  </div>

  <p:remoteCommand action="#{assistantBean.assist}" name="assist"
                   process="@this" update="@form:cnt:message_list @form:cnt:question" 
                   global="false"
                   oncomplete="scrollMessages()" />

  <gdm:saveBean value="assistantBean" />

  <script>
    function scrollMessages()
    {
      var elems = document.getElementsByClassName("message_list");
      if (elems.length > 0)
      {
        var elem = elems[0];
        elem.scrollTop = elem.scrollHeight;
      }
    }
    if (window.assistantResizeDetection === undefined)
    {
      window.addEventListener("resize", scrollMessages);
      window.assistantResizeDetection = true;
    }

    window.history.pushState({}, '', '/go.faces?xmid=#{userSessionBean.selectedMenuItem.mid}');
    document.title = "#{userSessionBean.selectedMenuItem.label}";
  </script>

</ui:composition>