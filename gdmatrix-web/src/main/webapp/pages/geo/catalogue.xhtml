<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:gdm="http://gdmatrix.org/faces"
                xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
                xmlns:pe="http://primefaces.org/ui/extensions">

  <f:loadBundle basename="org.santfeliu.web.obj.resources.ObjectBundle"
                var="objectBundle" />
  <h:outputStylesheet library="css" name="geo.css" />
  
  <div class="flex flex-column h-full overflow-hidden geo_catalogue">
    <div class="p-2 flex align-items-center flex-grow-0 border-none border-solid border-bottom-1"
         style="border-color:var(--surface-border)">
      <div class="flex-grow-1 align-items-center">
        <span class="pi pi-th-large"/>
        <strong>#{applicationBean.translate(userSessionBean.selectedMenuItem.label, 'geo')}</strong>
        <p:menuButton icon="pi pi-cog" buttonStyleClass="rounded-button ui-button-flat" styleClass="ml-2"
                      rendered="#{geoCatalogueBean.adminUser}">
          <p:menuitem icon="pi pi-plus-circle" 
                      action="#{geoCatalogueBean.createMapCategory}" value="Create category"
                      resetValues="true"
                      process="@this" update="@form:cnt:catalogue_category_dialog"
                      oncomplete="PF('catalogueCategoryDialog').show()" />
          <p:menuitem icon="pi pi-plus-circle" 
                      action="#{geoCatalogueBean.createMap}" value="Create map"
                      process="@this" update="@form:cnt" />
        </p:menuButton>
      </div>      
      <h:panelGroup id="map_filter" layout="block" styleClass="flex-grow-0 flex-shrink-1">
        <div class="ui-inputgroup">
          <p:inputText value="#{geoCatalogueBean.filter.keywords}"
                       pt:spellcheck="false" autocomplete="off" 
                       placeholder="#{objectBundle.search}" />
          <p:commandButton id="find_maps" widgetVar="findButton"
                           action="#{geoCatalogueBean.findMaps}"
                           icon="pi pi-search"
                           title="#{objectBundle.search}"
                           process="@form:cnt" update="@form:cnt:maps" />
          <p:defaultCommand target="find_maps" scope="map_filter" />
        </div>
      </h:panelGroup>
    </div>
    
    <p:messages showSummary="true" styleClass="messages pl-3 pr-3" 
                rendered="#{geoCatalogueBean.currentMapCategory == null}"
                showIcon="true" closable="true" forIgnores="growl login_messages">
      <p:autoUpdate />
    </p:messages>
    
    <h:panelGroup id="maps" layout="block" styleClass="flex-grow-1 overflow-auto pl-3 pr-3">

      <div class="pt-1">
        <h:outputFormat value="#{geoCatalogueBean.mapGroup.mapCount == 1 ? geoBundle.mapFound : geoBundle.mapsFound}">
          <f:param value="#{geoCatalogueBean.mapGroup.mapCount}" />
        </h:outputFormat>
      </div>

      <ul class="list-none pl-0">
        <ui:repeat value="#{geoCatalogueBean.mapGroup.mapViews}" var="mapView0">
          <ui:param name="mapView" value="#{mapView0}" />
          <ui:include src="/pages/geo/catalogue_map_view.xhtml" />
        </ui:repeat>
        <ui:repeat value="#{geoCatalogueBean.mapGroup.mapGroups}" var="mapGroup1">
          <li class="pt-1">
            <ui:param name="mapGroup" value="#{mapGroup1}" />
            <ui:include src="/pages/geo/catalogue_category_view.xhtml" />
            <ul class="list-none pl-4 pt-2 pb-2">
              <ui:repeat value="#{mapGroup1.mapViews}" var="mapView1">
                <ui:param name="mapView" value="#{mapView1}" />
                <ui:include src="/pages/geo/catalogue_map_view.xhtml" />
              </ui:repeat>
              <ui:repeat value="#{mapGroup1.mapGroups}" var="mapGroup2">
                <li class="pt-1">
                  <ui:param name="mapGroup" value="#{mapGroup2}" />
                  <ui:include src="/pages/geo/catalogue_category_view.xhtml" />                  
                  <ul class="list-none pl-4 pt-2">
                    <ui:repeat value="#{mapGroup2.mapViews}" var="mapView2">
                      <ui:param name="mapView" value="#{mapView2}" />
                      <ui:include src="/pages/geo/catalogue_map_view.xhtml" />
                    </ui:repeat>
                    <ui:repeat value="#{mapGroup2.mapGroups}" var="mapGroup3">
                      <li class="pt-1">
                        <ui:param name="mapGroup" value="#{mapGroup3}" />
                        <ui:include src="/pages/geo/catalogue_category_view.xhtml" />
                        <ul class="list-none pl-4 pt-2">
                          <ui:repeat value="#{mapGroup3.mapViews}" var="mapView3">
                            <ui:param name="mapView" value="#{mapView3}" />
                            <ui:include src="/pages/geo/catalogue_map_view.xhtml" />
                          </ui:repeat>
                        </ul>
                      </li>
                    </ui:repeat>
                  </ul>
                </li>
              </ui:repeat>
            </ul>
          </li>
        </ui:repeat>
      </ul>
    </h:panelGroup>
    
  </div>

  <p:fileUpload listener="#{geoCatalogueBean.uploadCategoryImage}"
                mode="simple" skinSimple="true" 
                widgetVar="categoryImageUpload" auto="true"
                process="@this" update="@form:cnt:maps"
                style="display:none" /> 
    
  <ui:include src="/pages/geo/catalogue_map_dialog.xhtml" />
  <ui:include src="/pages/geo/catalogue_category_dialog.xhtml" />
  
  <gdm:saveBean value="geoCatalogueBean" />
  
  <script>
    // remove duplicates in detachedWidgets
    PrimeFaces.detachedWidgets = PrimeFaces.detachedWidgets.filter(
      (value, index) => PrimeFaces.detachedWidgets.indexOf(value) === index);

    document.title = "#{userSessionBean.selectedMenuItem.label}";
    window.history.pushState({}, document.title, '/go.faces?xmid=#{userSessionBean.selectedMenuItem.mid}');

    setTimeout(() => window.location.hash = "");

    var elems = document.getElementsByClassName("current_map");
    if (elems.length > 0)
    {
      var elem = elems[0];
      elem.scrollIntoView({ behavior: "instant", block: "center", inline: "nearest" });
    }
  </script>

</ui:composition>